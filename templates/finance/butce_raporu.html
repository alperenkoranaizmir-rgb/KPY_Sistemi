{% extends 'admin/base.html' %}
{% load i18n jazzmin humanize %}

{% block title %}{{ baslik }}{% endblock %}

{% block content_title %}{{ baslik }}{% endblock %}

{% block content %}
<div class="container-fluid">
    
    {% if rapor_tablosu %}
    
    <div class="row">
        
        <div class="col-lg-4 col-6">
            <div class="small-box bg-info">
                <div class="inner">
                    <h3>{{ toplam_butce_genel|floatformat:2|intcomma }} ₺</h3>
                    <p>Planlanan Toplam Bütçe</p>
                </div>
                <div class="icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <span class="small-box-footer">Tüm aktif projeler için</span>
            </div>
        </div>
        
        <div class="col-lg-4 col-6">
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3>{{ toplam_maliyet_genel|floatformat:2|intcomma }} ₺</h3>
                    <p>Gerçekleşen Toplam Maliyet</p>
                </div>
                <div class="icon">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <span class="small-box-footer">Tüm aktif projelere harcanan</span>
            </div>
        </div>
        
        <div class="col-lg-4 col-6">
            {% if toplam_fark >= 0 %}
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ toplam_fark|floatformat:2|intcomma }} ₺</h3>
                        <p>Kalan Bütçe / Tasarruf</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <span class="small-box-footer">Toplamda bütçe dahilinde</span>
                </div>
            {% else %}
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ toplam_fark|floatformat:2|intcomma }} ₺</h3>
                        <p>Bütçe Aşımı / Eksik Kalan</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <span class="small-box-footer">Toplamda bütçe aşımı durumu</span>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Proje Bazlı Detaylı Karşılaştırma</h3>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th style="width: 10%">#</th>
                                <th>Proje Adı</th>
                                <th class="text-right">Planlanan Bütçe</th>
                                <th class="text-right">Fiili Maliyet</th>
                                <th style="width: 20%">Bütçe Kullanımı (%)</th>
                                <th class="text-right">Fark (Kalan / Aşım)</th>
                                <th style="width: 15%">Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rapor in rapor_tablosu %}
                            {% with butce_orani=rapor.fiili_maliyet|divisibleby:rapor.planlanan_butce %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ rapor.proje_adi }}</td>
                                <td class="text-right">{{ rapor.planlanan_butce|floatformat:2|intcomma }} ₺</td>
                                <td class="text-right">{{ rapor.fiili_maliyet|floatformat:2|intcomma }} ₺</td>
                                <td>
                                    {% if rapor.planlanan_butce > 0 %}
                                        {% with yuzde_kullanim=(rapor.fiili_maliyet|divisibleby:rapor.planlanan_butce) %}
                                        {% with gorunen_yuzde=yuzde_kullanim|floatformat:0 %}
                                            <div class="progress progress-xs">
                                                <div class="progress-bar {% if yuzde_kullanim > 100 %}bg-danger{% elif yuzde_kullanim > 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                                     style="width: {% if yuzde_kullanim > 100 %}100{% else %}{{ gorunen_yuzde }}{% endif %}%">
                                                </div>
                                            </div>
                                            <span class="badge bg-{% if yuzde_kullanim > 100 %}danger{% elif yuzde_kullanim > 80 %}warning{% else %}success{% endif %}">
                                                {{ gorunen_yuzde }}% Kullanıldı
                                            </span>
                                        {% endwith %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="badge bg-secondary">Bütçe Tanımlı Değil</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    <span class="text-{% if rapor.fark < 0 %}danger{% elif rapor.fark == 0 %}secondary{% else %}success{% endif %}">
                                        {% if rapor.fark < 0 %}<i class="fas fa-caret-down"></i>{% elif rapor.fark > 0 %}<i class="fas fa-caret-up"></i>{% endif %}
                                        {{ rapor.fark|floatformat:2|intcomma }} ₺
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-{% if rapor.fark < 0 %}danger{% else %}success{% endif %}">
                                        {{ rapor.durum }}
                                    </span>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="alert alert-warning" role="alert">
        Sistemde henüz aktif proje veya maliyet kaydı bulunmamaktadır.
    </div>
    {% endif %}

</div>

{% endblock %}